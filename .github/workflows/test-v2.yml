name: Test Krystal V2 Autonomous Generator

on:
  push:
    branches: [main, develop]
    paths:
      - 'krystal_v2/case_generator/autonomous/**'
      - 'test_v2_runner.py'
      - '.github/workflows/test-v2.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'krystal_v2/case_generator/autonomous/**'
      - 'test_v2_runner.py'
      - '.github/workflows/test-v2.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-v2-generator:
    name: V2 End-to-End Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      
      - name: Run V2 test suite
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4o
        run: |
          python test_v2_runner.py
      
      - name: Upload test report (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: v2-test-report-json
          path: V2_TEST_REPORT.json
          retention-days: 30
      
      - name: Upload test report (Markdown)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: v2-test-report-md
          path: V2_TEST_COMPLETE_SUMMARY.md
          retention-days: 30
      
      - name: Upload generated code
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: v2-generated-code
          path: generated_autonomous/data_generator_v2_*.py
          retention-days: 7
      
      - name: Check test results
        if: always()
        run: |
          if [ -f V2_TEST_REPORT.json ]; then
            python -c '
          import json
          with open("V2_TEST_REPORT.json") as f:
              report = json.load(f)
              print(f"Tests: {report[\"passed\"]}/{report[\"total\"]} passed")
              if not report["success"]:
                  print("❌ V2 tests failed")
                  exit(1)
              print("✅ V2 tests passed")
          '
          else
            echo "❌ Test report not found"
            exit 1
          fi

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      
      - name: Run unit tests
        run: |
          python run_unit_tests.py -v --cov
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: .coverage
          retention-days: 7

  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 mypy
          pip install -r requirements.txt
      
      - name: Check formatting with Black
        run: |
          black --check krystal/ krystal_v2/ --line-length 120
      
      - name: Lint with Flake8
        run: |
          flake8 krystal/ krystal_v2/ --max-line-length=120 --ignore=E501,W503 --count --statistics
      
      - name: Type check with MyPy
        continue-on-error: true  # Don't fail on type errors yet
        run: |
          mypy krystal_v2/case_generator/autonomous/ --ignore-missing-imports
